{% extends "base.html" %}
{% block title %}Deliveries - {{ user }}{% endblock %}
{% block scripts %}
    <script>
        let productOptions = [
            {% for product in products %}
                {
                    "product_id": {{ product.productID }},
                    "description": "{{ product.description }}",
                    "supplier_id": {{ product.supplier.supplierID }}
                },
            {% endfor %}
        ];

        $(document).ready(function() {
            {% if perms["DeliveryCreate"] %}
            $('#insertDeliveryModalForm')[0].reset();
            $('.product-select').attr("disabled", true);

            $('#supplier').on("change", function(event) {
                $(".product-select").each(function(index) {
                    $(this).empty();
                    $(this).removeAttr("disabled");
                    appendOptions($('#supplier').find(":selected").val(), $(this));
                });
            });
            {% endif %}

            {% if perms["DeliveryConfirm"] %}
            $('.confirm-modal-btn').on('click', function (event) {
                var deliveryid = $(this).attr('data-bs-deliveryid')

                $('#confirmModalText').text('Confirm delivery of order #' + deliveryid + '?')
                $('#confirmModalButton').attr('href', '/confirm_delivery?delivery_id=' + deliveryid)
            });
            {% endif %}

            {% if perms["DeliveryReject"] %}
            $('.reject-modal-btn').on('click', function (event) {
                var deliveryid = $(this).attr('data-bs-deliveryid')

                $('#rejectModalText').text('Reject delivery of order #' + deliveryid + '?')
                $('#rejectDeliveryID').attr('value', deliveryid)
            });
            {% endif %}

            var numItems = 1
            $('#additembtn').on('click', function (event) {
                let supplier_selected = $('#supplier').find(":selected").val();
                numItems += 1
                newRow = '<div id="add' + numItems + '" class="row mt-2 add-item-row">'
                    + '<div class="col-lg-6 ps-0">'
                    + '<select class="form-select product-select" id="product' + numItems + '" name="product" disabled required>'
                    + '<option selected value="">Choose a Supplier...</option>'
                    + '</select>'
                    + '</div>'
                    + '<div class="col-lg-6 p-0">'
                    + '<input type="number" class="form-control" id="stock' + numItems + '" name="stock" placeholder="Amount Ordered" pattern="\d*" min="0" required>'
                    + '</div>'
                    + '</div>'
                $('#insertDeliveryBody').append(newRow)
                if (supplier_selected != "") {
                    let this_row = $('.product-select').last();
                    this_row.removeAttr("disabled");
                    this_row.empty();
                    appendOptions(supplier_selected, this_row);
                }
            });

            $('#minusitembtn').on('click', function (event) {
                if (numItems > 1) {
                    $('.add-item-row').last().remove();
                    numItems -= 1;
                }
            });
        });

        function appendOptions(supplier_id, optionSelect) {
            optionSelect.append("<option selected disabled value=''>Choose Product...</option>")
            for (let i = 0; i < productOptions.length; i++) {
                if (productOptions[i].supplier_id == supplier_id) {
                    optionSelect.append("<option value='" + productOptions[i].product_id + "'>" + productOptions[i].description + "</option>");
                }
            }
        }
    </script>
{% endblock scripts %}
{% block modal %}
    {% if perms["DeliveryConfirm"] %}
        <div class="modal fade" id="confirmDeliveryModal" tabindex="-1" aria-labelledby="confirmDeliveryModal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Delivery</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="confirmModalText">Confirm delivery?</div>
                    </div>
                    <div class="modal-footer">
                        <a id="confirmModalButton" href="#" class="btn btn-warning">Confirm</a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    {% if perms["DeliveryReject"] %}
        <div class="modal fade" id="rejectDeliveryModal" tabindex="-1" aria-labelledby="rejectDeliveryModal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="{{ url_for("reject_delivery_endpoint") }}" method="POST">
                        <div class="modal-header">
                            <h5 class="modal-title">Reject Delivery</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <label id="rejectModalText" for="reason">Reject delivery?</label>
                            <input type="hidden" id="rejectDeliveryID" name="delivery_id" value="-1">
                            <input type="text" id="reason" name="reason" class="form-control mt-2" placeholder="Reason..." required>
                        </div>
                        <div class="modal-footer">
                            <button id="rejectModalButton" class="btn btn-warning">Confirm</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}
    {% if perms["DeliveryCreate"] %}
        <div class="modal fade" id="insertDeliveryModal" tabindex="-1" aria-labelledby="insertDeliveryModal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add a New Delivery</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="insertDeliveryModalForm" action="{{ url_for("add_delivery_endpoint") }}" method="POST">
                        <div class="modal-body">
                            <div id="insertDeliveryBody" class="container-fluid">
                                <div class="row">
                                    <div class="col-auto ps-0">
                                        <label for="datepicker" class="form-label mb-0 pt-1">Date Expected:</label>
                                    </div>
                                    <div class="col pe-0">
                                        <input id="datepicker" name="date" class="form-control pe-0" type="date" required>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <select class="form-select col-6" id="supplier" name="supplier_id" required>
                                            <option selected disabled value="">Choose Supplier...</option>
                                            {% for supplier in suppliers %}
                                                <option value="{{ supplier.supplierID }}">{{ supplier.name }}</option>
                                            {% endfor %}
                                    </select>
                                </div>
                                <div class="row">
                                    <div class="col pt-4"><hr class="mb-0"></div>

                                    <button id="additembtn" type="button" class="col-auto btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
      <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
    </svg></button>
                                    <button id="minusitembtn" type="button" class="col-auto btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dash-circle" viewBox="0 0 16 16">
      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
      <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
    </svg></button>
                                </div>
                                <div class="row mt-2 add-item-row">
                                    <div class="col-lg-6 ps-0">
                                        <select class="form-select product-select" id="product1" name="product" disabled required>
                                            <option selected disabled value="">Choose a Supplier...</option>
                                        </select>
                                    </div>
                                    <div class="col-lg-6 p-0">
                                        <input type="number" class="form-control" id="stock1" name="stock" placeholder="Amount Ordered" pattern="\d*" min="0" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-warning">Submit order</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock modal %}
{% block content %}
    <div class="container-fluid ms-0 mt-2 mb-5">
        <div class="row mb-2">
            <h3 class="col">Pending Deliveries</h3>
            {% if perms["DeliveryCreate"] %}
                <div class="col">
                    <button type="button" class="btn btn-warning float-end" data-bs-toggle="modal" data-bs-target="#insertDeliveryModal">
                        Add a new delivery
                    </button>
                </div>
            {% endif %}
        </div>
        <hr>
        <div class="row row-cols-1 row-cols-lg-3">
            {% for delivery in deliveries %}
                {% if delivery.status == "pending" %}
                    <div class="col mt-3">
                        <div class="card p-0 h-100">
                            <div class="card-header">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div class="card-title col-2 text-muted fs-6">#{{ delivery.deliveryID }}</div>
                                        <div class="col">
                                            <div class="float-end"><span class="text-muted">Date Ordered:</span> {{ delivery.dateOrdered }}</div>
                                        </div>
                                    </div>
                                    <div class="row justify-content-end">
                                        <div class="col">
                                            <div class="float-end"><span class="text-muted">Date Expected:</span> {{ delivery.dateExpected }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="container-fluid">
                                    {% for order in delivery.items %}
                                        <div class="row">
                                            <div class="col-5">{{ order.product.description }}</div>
                                            <div class="col-3 text-muted">x{{ order.quantityOrdered }}</div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="row justify-content-end">
                                    {% if perms["DeliveryConfirm"] %}
                                        <div class="col-auto">
                                            <button type="button" class="btn btn-outline-secondary confirm-modal-btn" data-bs-deliveryid="{{ delivery.deliveryID }}" data-bs-toggle="modal" data-bs-target="#confirmDeliveryModal">&checkmark;</button>
                                        </div>
                                    {% endif %}
                                    {% if perms["DeliveryReject"] %}
                                        <div class="col-auto ps-0">
                                            <button type="button" class="btn btn-outline-secondary reject-modal-btn" data-bs-deliveryid="{{ delivery.deliveryID }}" data-bs-toggle="modal" data-bs-target="#rejectDeliveryModal">&#x2715;</button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <h3 class="mt-3">Completed Deliveries</h3>
        <hr>
        <div class="row row-cols-1 row-cols-lg-3">
            {% for delivery in deliveries %}
                {% if delivery.status == "delivered" %}
                    <div class="col mt-3">
                        <div class="card p-0 h-100">
                            <div class="card-header">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div class="card-title col-2 text-muted fs-6">#{{ delivery.deliveryID }}</div>
                                        <div class="col">
                                            <div class="float-end"><span class="text-muted">Date Ordered:</span> {{ delivery.dateOrdered }}</div>
                                        </div>
                                    </div>
                                    <div class="row justify-content-end">
                                        <div class="col">
                                            <div class="float-end"><span class="text-muted">Date Expected:</span> {{ delivery.dateExpected }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="container-fluid">
                                    {% for order in delivery.items %}
                                        <div class="row">
                                            <div class="col-5">{{ order.product.description }}</div>
                                            <div class="col-3 text-muted">x{{ order.quantityOrdered }}</div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <h3 class="mt-3">Rejected Deliveries</h3>
        <hr>
        <div class="row row-cols-1 row-cols-lg-3">
            {% for delivery in deliveries %}
                {% if delivery.status == "rejected" %}
                    <div class="col mt-3">
                        <div class="card p-0 h-100">
                            <div class="card-header">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div class="card-title col-2 text-muted fs-6">#{{ delivery.deliveryID }}</div>
                                        <div class="col">
                                            <div class="float-end"><span class="text-muted">Date Ordered:</span> {{ delivery.dateOrdered }}</div>
                                        </div>
                                    </div>
                                    <div class="row justify-content-end">
                                        <div class="col">
                                            <div class="float-end"><span class="text-muted">Date Expected:</span> {{ delivery.dateExpected }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="container-fluid">
                                    {% for order in delivery.items %}
                                        <div class="row">
                                            <div class="col-5">{{ order.product.description }}</div>
                                            <div class="col-3 text-muted">x{{ order.quantityOrdered }}</div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="row justify-content-end">
                                    <div class="col-auto text-muted">
                                        {{ delivery.reason }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endblock content %}